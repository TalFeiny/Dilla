# Lago Self-Hosted Billing Stack
# Run with: docker-compose -f docker-compose.lago.yml up -d
# Access Lago UI at: http://localhost:80

version: '3.8'

services:
  # PostgreSQL Database for Lago
  lago-postgres:
    image: postgres:14-alpine
    container_name: lago-postgres
    environment:
      POSTGRES_DB: lago
      POSTGRES_USER: lago
      POSTGRES_PASSWORD: ${LAGO_DB_PASSWORD:-securepassword123}
    volumes:
      - lago-postgres-data:/var/lib/postgresql/data
    networks:
      - lago-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lago"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for background jobs
  lago-redis:
    image: redis:6-alpine
    container_name: lago-redis
    networks:
      - lago-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Lago API
  lago-api:
    image: getlago/api:latest
    container_name: lago-api
    depends_on:
      lago-postgres:
        condition: service_healthy
      lago-redis:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://lago:${LAGO_DB_PASSWORD:-securepassword123}@lago-postgres:5432/lago
      REDIS_URL: redis://lago-redis:6379
      SECRET_KEY_BASE: ${LAGO_SECRET_KEY:-your-secret-key-at-least-64-chars-long-for-production}
      RAILS_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
      LAGO_API_URL: ${LAGO_API_URL:-http://localhost:3000}
      LAGO_PDF_URL: http://lago-pdf:3000
      LAGO_REDIS_CACHE_URL: redis://lago-redis:6379/0
      LAGO_DISABLE_SEGMENT: "true"  # Disable analytics
      LAGO_OAUTH_PROXY_URL: https://oauth.getlago.com
      LAGO_FROM_EMAIL: ${LAGO_FROM_EMAIL:-billing@dilla.ai}
      LAGO_REPLY_TO_EMAIL: ${LAGO_REPLY_TO_EMAIL:-support@dilla.ai}
      RSA_PRIVATE_KEY: ${LAGO_RSA_PRIVATE_KEY}  # Generate with: openssl genrsa 2048
      ENCRYPTION_PRIMARY_KEY: ${LAGO_ENCRYPTION_PRIMARY_KEY:-your-encryption-key-32-chars}
      ENCRYPTION_DETERMINISTIC_KEY: ${LAGO_ENCRYPTION_DETERMINISTIC_KEY:-your-deterministic-key-32-chars}
      ENCRYPTION_KEY_DERIVATION_SALT: ${LAGO_ENCRYPTION_KEY_DERIVATION_SALT:-your-salt-key-32-chars}
    volumes:
      - lago-storage:/app/storage
    ports:
      - "3000:3000"
    networks:
      - lago-network
    command: ["sh", "-c", "bundle exec rails db:prepare && bundle exec puma -C config/puma.rb"]

  # Background Worker (Sidekiq)
  lago-worker:
    image: getlago/api:latest
    container_name: lago-worker
    depends_on:
      - lago-api
    environment:
      DATABASE_URL: postgresql://lago:${LAGO_DB_PASSWORD:-securepassword123}@lago-postgres:5432/lago
      REDIS_URL: redis://lago-redis:6379
      SECRET_KEY_BASE: ${LAGO_SECRET_KEY:-your-secret-key-at-least-64-chars-long-for-production}
      RAILS_ENV: production
      LAGO_API_URL: ${LAGO_API_URL:-http://localhost:3000}
      LAGO_PDF_URL: http://lago-pdf:3000
      LAGO_REDIS_CACHE_URL: redis://lago-redis:6379/0
      ENCRYPTION_PRIMARY_KEY: ${LAGO_ENCRYPTION_PRIMARY_KEY:-your-encryption-key-32-chars}
      ENCRYPTION_DETERMINISTIC_KEY: ${LAGO_ENCRYPTION_DETERMINISTIC_KEY:-your-deterministic-key-32-chars}
      ENCRYPTION_KEY_DERIVATION_SALT: ${LAGO_ENCRYPTION_KEY_DERIVATION_SALT:-your-salt-key-32-chars}
    volumes:
      - lago-storage:/app/storage
    networks:
      - lago-network
    command: ["bundle", "exec", "sidekiq", "-C", "config/sidekiq.yml"]

  # Clock for scheduled jobs
  lago-clock:
    image: getlago/api:latest
    container_name: lago-clock
    depends_on:
      - lago-api
    environment:
      DATABASE_URL: postgresql://lago:${LAGO_DB_PASSWORD:-securepassword123}@lago-postgres:5432/lago
      REDIS_URL: redis://lago-redis:6379
      SECRET_KEY_BASE: ${LAGO_SECRET_KEY:-your-secret-key-at-least-64-chars-long-for-production}
      RAILS_ENV: production
      LAGO_API_URL: ${LAGO_API_URL:-http://localhost:3000}
    networks:
      - lago-network
    command: ["bundle", "exec", "clockwork", "clock.rb"]

  # PDF Generator Service
  lago-pdf:
    image: getlago/pdf:latest
    container_name: lago-pdf
    networks:
      - lago-network
    environment:
      NODE_ENV: production

  # Lago Frontend UI
  lago-front:
    image: getlago/front:latest
    container_name: lago-front
    depends_on:
      - lago-api
    environment:
      API_URL: http://lago-api:3000
      APP_ENV: production
      CODEGEN_API: http://lago-api:3000
    ports:
      - "80:80"
    networks:
      - lago-network

volumes:
  lago-postgres-data:
  lago-storage:

networks:
  lago-network:
    driver: bridge